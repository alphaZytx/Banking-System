# syntax=docker/dockerfile:1
FROM eclipse-temurin:17-jdk AS builder
WORKDIR /workspace
COPY src ./src
RUN find src -name '*.java' > sources.txt \
    && mkdir -p build/classes \
    && javac -d build/classes @sources.txt \
    && jar --create --file build/banking-api.jar --main-class banking.api.ApiApplication -C build/classes .

FROM eclipse-temurin:17-jre
WORKDIR /opt/app
RUN apt-get update \
    && apt-get install --no-install-recommends -y curl \
    && rm -rf /var/lib/apt/lists/*
COPY --from=builder /workspace/build/banking-api.jar ./banking-api.jar
ENV BANKING_STORAGE_MODE=jdbc
ENV BANKING_API_PORT=8080
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "./banking-api.jar"]
